# Rule: Improve Proto API Creation Rule (action)

**Purpose**: Iteratively improve the `model-stigmer-protos.mdc` rule based on real-world proto API creation, errors, and feedback.

**Usage**: Invoke this rule when you encounter issues or learn something valuable while creating Stigmer proto APIs.

---

## üö¶ Quick Decision: Should You Document This Learning?

**Before proceeding, check if this learning is worth documenting:**

```
Did you create a proto API or learn something?
‚îú‚îÄ YES ‚Üí Is it already in docs/learning-log.md?
‚îÇ         ‚îú‚îÄ NO ‚Üí ‚úÖ Document it! (proceed below)
‚îÇ         ‚îî‚îÄ YES ‚Üí ‚è≠Ô∏è Skip (already captured)
‚îÇ
‚îî‚îÄ NO ‚Üí ‚è≠Ô∏è No action needed
```

### ‚úÖ Document If ANY Of These Are True

- ‚úÖ Created proto for new resource
- ‚úÖ Discovered reusable validation pattern
- ‚úÖ Found authorization configuration gap
- ‚úÖ Hit file organization issue
- ‚úÖ Created complex message structure
- ‚úÖ Designed new resource standard
- ‚úÖ Solved multi-scope authorization
- ‚úÖ Created custom validation rule
- ‚úÖ Fixed proto compilation error

### ‚è≠Ô∏è Skip If

- ‚ùå Exact copy of existing proto
- ‚ùå Already documented in standards
- ‚ùå Trivial message field addition

---

## üìä Quick Check: Where Should This Go?

| What You Learned | Learning Log Section | Consider Topic Doc? |
|-----------------|---------------------|-------------------|
| New proto API created | File Organization Patterns | If new structure |
| Validation constraint | Validation Patterns | If reusable |
| Authorization config | Authorization Configuration | If new pattern |
| File structure issue | File Organization | **Important** |
| API resource standard | API Resource Standards | If new field/pattern |
| Proto compilation error | Common Mistakes | **Always** |

---

## The Hybrid Documentation Approach

This rule uses a **dual-track documentation system**:

### 1. Topic-Specific Reference Docs (Standards & Patterns)

**Location**: `docs/{topic-name}.md`

**Purpose**: Reusable proto patterns and standards

**Create when:**
- ‚úÖ Pattern used 2-3+ times (stabilized)
- ‚úÖ Standard that applies to all protos
- ‚úÖ Complex structure worth documenting
- ‚úÖ Common mistake needing prevention

**Current Topic Docs:**
- `organization-patterns.md` - 5-file proto structure guide
- `api-resource-standards.md` - Kubernetes-inspired resource standards

**Future Topic Docs:**
- `validation-patterns.md` - buf.validate best practices
- `authorization-configuration.md` - RPC authorization patterns
- `common-mistakes.md` - Error catalog
- `shared-messages.md` - Cross-domain message organization
- `versioning-guide.md` - v1 ‚Üí v2 migration patterns

---

### 2. Learning Log (Evolution Record)

**Location**: `docs/learning-log.md`

**Purpose**: Chronicle of proto API creation evolution

**Structure**: Organized by topic with dates

**Add to when:**
- ‚úÖ Create proto API for new resource
- ‚úÖ Discover new validation pattern
- ‚úÖ Encounter proto organization issue
- ‚úÖ Learn from proto ‚Üí FGA ‚Üí backend integration

**Format:**
```markdown
## Topic Category

### YYYY-MM-DD: Brief Title

**Pattern**: Description or issue

**Proto Code** (if applicable):
```protobuf
{proto definitions}
```

**Impact**: What this enables or prevents

**Reference Doc**: Link to topic doc (if pattern extracted)
```

---

## Self-Improvement Workflow

**When creating proto APIs or encountering issues:**

### Step 1: Add to Learning Log

1. **Open** `docs/learning-log.md`
2. **Find or create** appropriate topic section
3. **Add entry** with:
   - Date
   - Pattern or issue description
   - Proto code examples
   - Impact and lessons learned
   - Reference to topic doc (if exists)

**Example:**
```markdown
## Validation Patterns

### 2026-01-20: Email Validation Pattern

**Pattern**: Email fields require regex validation for proper format.

**Proto Code**:
```protobuf
string email = 1 [(buf.validate.field).string = {
  min_len: 1,
  max_len: 320,
  pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
}];
```

**Impact**: Catches invalid emails at proto validation, before database.

**Reference Doc**: Pattern added to `validation-patterns.md`
```

---

### Step 2: Decide If Topic Doc Needed

**Create new topic doc if:**
- ‚úÖ Pattern used for 2+ resources
- ‚úÖ Standard that should apply to all protos
- ‚úÖ Complex enough to need comprehensive guide
- ‚úÖ Common mistake worth preventing
- ‚ùå One-off unique proto (stays in log only)

**Update existing topic doc if:**
- ‚úÖ New example strengthens standard
- ‚úÖ Variation of existing pattern
- ‚úÖ Additional use case discovered
- ‚úÖ Correction to existing guidance

**Topic doc template:**
```markdown
# {Pattern/Standard Name}

## Overview

{Description of pattern and when to use}

## Proto Structure

```protobuf
{proto code example}
```

## Use Cases

- Resource type 1: {example}
- Resource type 2: {example}

## Variations

### Variation 1: {Name}
{Description and proto code}

## Common Mistakes

### Mistake 1: {Description}

‚ùå **WRONG**:
```protobuf
{incorrect proto}
```

‚úÖ **CORRECT**:
```protobuf
{correct proto}
```

## Verification Checklist

- [ ] Item 1
- [ ] Item 2

## Integration

**FGA Impact**: {how this affects FGA modeling}
**Backend Impact**: {how this affects handler generation}

## Related Patterns

- {Links to related patterns}
```

---

### Step 3: Update Main Rule's Reference Documentation Section

‚ö†Ô∏è **MANDATORY**: When you create or significantly update a topic doc, you MUST add/update it in the main rule's "Reference Documentation" section.

**Why This is Critical**:
- Standards docs are only useful if they're referenced in the main rule
- AI reads the main rule during proto creation - if docs aren't listed, they won't be consulted
- Documentation without visibility = documentation that doesn't exist

**How to Update Reference Documentation Section**:

1. **Open main rule**: `model-stigmer-protos.mdc`

2. **Find "Reference Documentation" section** (near top, after Prerequisites)

3. **Add new doc in appropriate category**:

   **Core Standards**:
   ```markdown
   - **Organization Patterns**: `docs/organization-patterns.md` ‚ö†Ô∏è **5-file structure**
   - **[NEW DOC]**: `docs/new-standard.md` ‚ö†Ô∏è **Description**
   ```

   **Learning & Evolution** (always present):
   ```markdown
   - **Learning Log**: `docs/learning-log.md` - All proto APIs created
   - **Complete Index**: `docs/README.md` - Full catalog
   ```

**Verification**: New doc appears in Reference Documentation section before next proto creation.

---

### Step 4: Update Main Rule Content (If Critical)

**Update main rule CONTENT if:**
- ‚úÖ New critical standard discovered
- ‚úÖ Warning needed to prevent errors
- ‚úÖ Process step needs clarification
- ‚úÖ Common mistake severe enough for mention

**Keep in topic docs if:**
- ‚úÖ Detailed pattern variations
- ‚úÖ Comprehensive examples
- ‚úÖ Multiple use cases
- ‚úÖ Background information

---

### Step 5: Update docs/README.md

If you created a new topic doc:
- Add it to `docs/README.md`
- Include brief description
- Mark as critical if needed

---

## Process for Different Learning Types

### Type 1: New Proto API Creation

**When**: Creating proto API for new resource

**Actions**:
1. ‚úÖ Follow 5-file organization pattern
2. ‚úÖ Apply API resource standards
3. ‚úÖ Configure authorization
4. ‚úÖ Add validations
5. ‚úÖ Add to `learning-log.md` with proto snippets
6. ‚úÖ If new pattern ‚Üí create/update topic doc

**Example**: Creating proto for new `agent_execution` resource

---

### Type 2: Validation Pattern Discovery

**When**: Find reusable validation constraint

**Actions**:
1. ‚úÖ Add to `learning-log.md` under "Validation Patterns"
2. ‚úÖ If used 2+ times ‚Üí add to `validation-patterns.md`
3. ‚úÖ Update main rule with reference

**Example**: Discovered URL validation pattern with protocol requirement

---

### Type 3: File Organization Violation

**When**: Encountered or prevented file structure mistake

**Actions**:
1. ‚úÖ Add to `learning-log.md` under "File Organization"
2. ‚úÖ Add to `common-mistakes.md` catalog
3. ‚úÖ Show wrong vs right structure
4. ‚úÖ Strengthen warning in main rule if needed

**Example**: Service defined in api.proto instead of command.proto

---

### Type 4: Authorization Pattern

**When**: Learned something about RPC authorization config

**Actions**:
1. ‚úÖ Add to `learning-log.md` under "Authorization Configuration"
2. ‚úÖ Create/update `authorization-configuration.md`
3. ‚úÖ Cross-reference backend handler rule
4. ‚úÖ Document FGA implications

**Example**: Alternative key lookup authorization pattern

---

### Type 5: API Resource Standard Evolution

**When**: New standard field or structure discovered

**Actions**:
1. ‚úÖ Add to `learning-log.md` under "API Resource Standards"
2. ‚úÖ Update `api-resource-standards.md`
3. ‚úÖ Update main rule if critical
4. ‚úÖ Document impact on existing protos

**Example**: New standard metadata field for resource tagging

---

## Proto-Specific Guidelines

### What Makes a Good Proto Pattern Doc

**Characteristics:**
- Clear proto code examples
- Multiple resource examples
- Shows validation constraints
- Documents authorization impact
- Links to FGA and backend patterns
- Verification checklist

**Structure:**
1. Overview and when to use
2. Proto structure with code
3. Real-world examples
4. Common variations
5. Mistakes to avoid
6. Integration impacts

---

### What Makes a Good Proto Learning Entry

**Characteristics:**
- Includes proto code snippets
- Shows before/after if correction
- Explains reasoning behind structure
- Notes validation choices
- Documents authorization decisions
- Links to pattern doc if extracted

**Example:**
```markdown
### 2026-01-20: AgentExecution Proto API

**Pattern**: New resource following 5-file organization.

**Files Created**:
- `apis/ai/stigmer/agentic/agentexecution/v1/api.proto`
- `apis/ai/stigmer/agentic/agentexecution/v1/spec.proto`
- `apis/ai/stigmer/agentic/agentexecution/v1/command.proto`
- `apis/ai/stigmer/agentic/agentexecution/v1/query.proto`
- `apis/ai/stigmer/agentic/agentexecution/v1/io.proto`

**Authorization**: Parent-based (inherits from agent relation)

**Validation**: Added execution_time timestamp validation

**Reference Doc**: Standard 5-file pattern in `organization-patterns.md`
```

---

## Documentation Structure

```
model-stigmer-protos/
‚îú‚îÄ‚îÄ model-stigmer-protos.mdc             # Main rule
‚îú‚îÄ‚îÄ improve-this-rule.mdc                # This file
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ README.md                        # Index
    ‚îú‚îÄ‚îÄ learning-log.md                  # Historical record (by topic)
    ‚îÇ
    ‚îú‚îÄ‚îÄ organization-patterns.md         # 5-file structure
    ‚îî‚îÄ‚îÄ api-resource-standards.md        # Kubernetes-inspired standards
```

---

## Verification Checklist

After making improvements:

- [ ] Added entry to `docs/learning-log.md` under correct topic
- [ ] Created/updated topic doc if pattern stabilized
- [ ] **‚ö†Ô∏è CRITICAL**: Updated main rule's "Reference Documentation" section if new doc created
- [ ] Updated main rule content if critical standard needs warning
- [ ] Proto code examples are complete and correct
- [ ] Authorization impact documented
- [ ] FGA integration noted
- [ ] Backend handler impact described
- [ ] `docs/README.md` updated if new doc created
- [ ] Cross-references to related rules added
- [ ] New docs are categorized correctly in Reference Documentation

---

## Anti-Patterns to Avoid

‚ùå **Don't**: Create protos without following 5-file organization
‚úÖ **Do**: Use `organization-patterns.md` as template

‚ùå **Don't**: Skip authorization configuration
‚úÖ **Do**: Configure authorization for every RPC (or explicitly document skip)

‚ùå **Don't**: Forget validation constraints
‚úÖ **Do**: Add buf.validate rules to all fields

‚ùå **Don't**: Violate API resource standards
‚úÖ **Do**: Follow Kubernetes-inspired structure (api_version, kind, metadata, spec, status)

‚ùå **Don't**: Make learning log purely chronological
‚úÖ **Do**: Group by topic (File Organization, Validation, Authorization, etc.)

‚ùå **Don't**: Create topic doc for every proto
‚úÖ **Do**: Wait until pattern is used 2-3+ times

---

## Cross-Rule Integration

**Proto API ‚Üí FGA Modeling ‚Üí Backend Handlers**:

When you create a proto API:
1. Proto defines resource structure and RPCs
2. FGA model defines authorization relations (based on proto)
3. Backend handlers implement proto RPCs (create IAM policies based on FGA)

**Learning flow**:
- Proto authorization config ‚Üí FGA relations ‚Üí Backend policy creation
- Learnings from any layer can improve all three rules

**Cross-references**:
- Proto ‚Üí `@model-stigmer-fga-authorization` (design FGA model)
- Proto ‚Üí `@implement-stigmer-backend-handlers` (implement RPCs)
- Both rules reference back to proto for structure

---

## Example Improvement Session

**Scenario**: Created proto for `agent_execution` resource

**Steps:**

### 1. Add to Learning Log

```markdown
## File Organization Patterns

### 2026-01-20: AgentExecution Proto - Complete 5-File Structure

**Pattern**: Created new resource following established organization.

**Files**:
```
apis/ai/stigmer/agentic/agentexecution/v1/
‚îú‚îÄ‚îÄ api.proto          # AgentExecution message (ApiVersion, Kind, Metadata, Spec, Status)
‚îú‚îÄ‚îÄ spec.proto         # AgentExecutionSpec (execution config)
‚îú‚îÄ‚îÄ command.proto      # AgentExecutionCommandController service
‚îú‚îÄ‚îÄ query.proto        # AgentExecutionQueryController service
‚îî‚îÄ‚îÄ io.proto           # CreateInput, UpdateInput, AgentExecutions
```

**Authorization**: Configured for all RPCs (can_edit for commands, can_view for queries)

**Validation**: Added execution_time, status enum, result size limits

**Impact**: Clean structure, consistent with other resources

**Reference Doc**: See `organization-patterns.md` - 5-file pattern
```

### 2. No New Pattern Doc Needed

Pattern already documented in `organization-patterns.md`. This is an application of existing pattern, not a new one.

### 3. Verify

- ‚úÖ Learning log has entry with file list
- ‚úÖ Authorization documented
- ‚úÖ Validation noted
- ‚úÖ No main rule update needed (standard pattern)
- ‚úÖ Ready for FGA modeling and backend implementation

---

## Meta: Improving This Meta-Rule

If this improvement rule itself needs improvement:
- Follow the same process
- Add to `docs/learning-log.md` under appropriate category
- Keep focused on proto API creation process
- Don't get too recursive

---

## Summary: The Hybrid Approach for Proto APIs

**Why both learning log AND pattern docs?**

| Learning Log | Pattern Docs |
|-------------|--------------|
| Record of each proto created | Reusable standards |
| Chronicles discovery process | Current best practices |
| Shows evolution of patterns | Template structures |
| Includes reasoning | Organized by concept |

**Result:**
- Main rule stays focused on process
- Pattern docs provide templates and standards
- Learning log preserves context and evolution
- All three enable rapid proto API creation

---

**Goal**: Continuously improve proto API creation through pattern discovery and standardization, maintaining clean organization via hybrid documentation (standards library + organized learning log + concise main rule).
