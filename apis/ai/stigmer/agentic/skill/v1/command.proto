syntax = "proto3";

package ai.stigmer.agentic.skill.v1;

import "ai/stigmer/agentic/skill/v1/api.proto";
import "ai/stigmer/agentic/skill/v1/io.proto";
import "ai/stigmer/commons/apiresource/rpc_service_options.proto";
import "ai/stigmer/iam/iampolicy/v1/rpcauthorization/method_options.proto";

// SkillCommandController handles write operations for skills.
service SkillCommandController {
  option (ai.stigmer.commons.apiresource.api_resource_kind) = skill;

  // Push (upload) a skill artifact.
  // This operation creates a new skill if it doesn't exist, or creates a new version
  // of an existing skill. The skill artifact must contain SKILL.md.
  //
  // Authorization:
  // - Organization-scoped skills: Caller must have can_create_skill permission in the organization
  // - Platform-scoped skills: Caller must be a platform operator (handled automatically by common auth step)
  //
  // The backend will:
  // 1. Normalize the name to a slug
  // 2. Find or create the skill resource
  // 3. Extract SKILL.md from the artifact
  // 4. Calculate SHA256 hash (version identifier)
  // 5. Store the artifact (deduplicated by hash)
  // 6. Update skill spec and status
  // 7. Archive the previous version (if updating)
  rpc push(PushSkillRequest) returns (PushSkillResponse) {
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).resource_kind = organization;
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).permission = can_create_skill;
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).field_path = "org";
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).error_msg = "unauthorized to push skill in this organization";
  }

  // Delete a skill and all its versions.
  // This removes the skill from the main collection but preserves audit history.
  rpc delete(SkillId) returns (Skill) {
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).resource_kind = skill;
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).permission = can_delete;
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).field_path = "value";
    option (ai.stigmer.iam.iampolicy.v1.rpcauthorization.config).error_msg = "unauthorized to delete skill";
  }
}
