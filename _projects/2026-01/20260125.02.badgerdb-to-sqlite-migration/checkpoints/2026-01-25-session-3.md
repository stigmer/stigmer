# Session Notes: 2026-01-25 (Session 3)

## Summary
Bug fixes for audit query ordering and test enum naming.

## Accomplishments
- Fixed `GetAuditByTag` timestamp ordering bug (sub-second inserts)
- Fixed `ListAuditHistory` timestamp ordering bug (sub-second inserts)  
- Fixed `push_test.go` enum name (`ApiResourceOwnerScope_platform`)
- Committed all fixes: `1f13f50`
- All store tests pass (27 tests)
- 36/37 skill controller tests pass (1 pre-existing failure)

## Decisions Made
- **Timestamp tiebreaker**: Added `id DESC` as secondary sort criterion in audit queries because SQLite's `datetime('now')` has second-level precision. When multiple records are inserted within the same second, the auto-increment `id` provides deterministic ordering.

## Key Code Changes
- `backend/libs/go/store/sqlite/store.go`:
  - `GetAuditByTag`: Changed `ORDER BY archived_at DESC` to `ORDER BY archived_at DESC, id DESC`
  - `ListAuditHistory`: Changed `ORDER BY archived_at DESC` to `ORDER BY archived_at DESC, id DESC`
- `backend/services/stigmer-server/pkg/domain/skill/controller/push_test.go`:
  - Fixed undefined enum `ApiResourceScope_API_RESOURCE_SCOPE_PLATFORM` to `ApiResourceOwnerScope_platform`

## Learnings
- SQLite `datetime('now')` has only second-level precision, not milliseconds
- When testing code that makes rapid sequential inserts, timestamp-only ordering can be non-deterministic
- Auto-increment IDs provide a reliable tiebreaker for ordering

## Open Questions
- Should the pre-existing `TestGetArtifact_EmptyStorageKey` failure be fixed? (Validation pipeline doesn't wrap errors as gRPC status)
- Should we add foreign key constraints for CASCADE DELETE on the audit table?

## Next Session Plan
- Consider creating a PR for the migration branch
- Optionally fix the validation pipeline gRPC status wrapping
- Manual integration testing of skill workflows
