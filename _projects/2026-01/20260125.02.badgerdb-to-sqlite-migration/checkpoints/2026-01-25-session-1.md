# Session Notes: 2026-01-25

## Accomplishments

### Complete BadgerDB to SQLite Migration
Successfully migrated the entire storage layer from BadgerDB to SQLite while preserving the exact same interface contract.

**New Files Created:**
- `backend/libs/go/store/sqlite/store.go` - SQLite implementation (~270 lines)
- `backend/libs/go/store/sqlite/store_test.go` - Comprehensive tests (~700 lines)
- `backend/libs/go/store/sqlite/BUILD.bazel` - Bazel config

**Files Deleted:**
- `backend/libs/go/badger/` - Entire BadgerDB package (store.go, store_test.go, BUILD.bazel)
- `backend/services/stigmer-server/pkg/debug/` - Debug HTTP endpoint (http.go, BUILD.bazel)

**Files Modified:**
- 60+ files across controllers, temporal activities, server initialization, and build configs

## Decisions Made

### 1. Write Serialization with Mutex
**Decision**: Use Go mutex to serialize write operations  
**Rationale**: SQLite only supports single writer. For local daemon use case, mutex serialization is appropriate and simpler than retry logic. WAL mode + mutex provides reliable concurrent reads during writes.

### 2. Interface Type in Controllers
**Decision**: Controllers use `store.Store` interface type, not concrete `*sqlite.Store`  
**Rationale**: Enables future backend swaps (e.g., memory store for testing) without touching consumers. Clean abstraction layer.

### 3. Test File Dual Imports
**Decision**: Test files import both `store` (interface) and `store/sqlite` (implementation)  
**Rationale**: Tests return `store.Store` interface type but construct concrete `sqlite.Store`. Keeps return types interface-based for flexibility.

### 4. Debug Endpoint Removal
**Decision**: Remove custom debug HTTP endpoint entirely  
**Rationale**: SQLite databases are accessible via standard tools (sqlite3 CLI, DataGrip, DB Browser for SQLite, VS Code extensions). Custom web UI adds maintenance burden without unique value.

### 5. GLOB vs LIKE for Prefix Matching
**Decision**: Use `GLOB 'prefix*'` instead of `LIKE 'prefix%'`  
**Rationale**: GLOB with constant prefix uses index effectively in SQLite. Case-sensitive (appropriate for IDs).

## Key Code Patterns

### SQLite Store Constructor
```go
func NewStore(dbPath string) (*Store, error) {
    // Create parent directory
    os.MkdirAll(filepath.Dir(dbPath), 0755)
    
    // Open with pragma configuration
    pragmas := []string{
        "PRAGMA journal_mode=WAL",      // Concurrent reads
        "PRAGMA synchronous=NORMAL",    // Balance durability/speed
        "PRAGMA busy_timeout=5000",     // 5s lock wait
        "PRAGMA cache_size=-64000",     // 64MB cache
    }
    
    // Run schema migrations
    runMigrations(db)
}
```

### Controller Migration Pattern
```go
// Before
import "github.com/stigmer/stigmer/backend/libs/go/badger"
type Controller struct { store *badger.Store }
func NewController(store *badger.Store) *Controller

// After
import "github.com/stigmer/stigmer/backend/libs/go/store"
type Controller struct { store store.Store }
func NewController(store store.Store) *Controller
```

## Learnings

### 1. Go Test Imports Need Both Packages
When a test file uses both interface type and concrete constructor, it needs imports for both:
```go
import (
    "github.com/stigmer/stigmer/backend/libs/go/store"        // For store.Store
    "github.com/stigmer/stigmer/backend/libs/go/store/sqlite" // For sqlite.NewStore
)
```

### 2. Bazel Library vs Test Dependencies
- Library deps should reference interface: `//backend/libs/go/store`
- Test deps may need implementation: `//backend/libs/go/store/sqlite`

### 3. modernc.org/sqlite Registers as "sqlite"
The pure Go SQLite driver from modernc.org registers as driver name "sqlite", not "sqlite3".

## Open Questions

None - implementation is complete.

## Next Session Plan

1. **Commit Changes**: Create proper commit with conventional commit message
2. **Create PR**: If desired, create pull request for review
3. **Bazel Build**: Verify full Bazel build succeeds
4. **Binary Size**: Measure binary size increase (~5MB expected)

## Statistics

- **Files Modified**: 72+
- **Lines Added**: ~1000 (new SQLite implementation + tests)
- **Lines Deleted**: ~800 (BadgerDB + debug endpoint)
- **Test Count**: 20+ new tests
- **All Tests Pass**: Yes
