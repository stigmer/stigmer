# Go Code Generation Principles

**Project**: SDK Code Generators  
**Created**: 2026-01-22

---

## Core Principles

### 1. Generated Code Should Be Indistinguishable from Hand-Written Code

**Goal**: Developers shouldn't be able to tell what's generated vs manual.

**Guidelines**:
- ‚úÖ Proper formatting (`gofmt`, `goimports`)
- ‚úÖ Idiomatic Go patterns (not "generated-looking" code)
- ‚úÖ Meaningful variable names (not `var1`, `temp`, etc.)
- ‚úÖ Complete documentation comments
- ‚úÖ Proper error handling (no panic in library code)

**Example**:

```go
// ‚úÖ GOOD - Looks hand-written
// SetTaskConfig defines the configuration for SET tasks.
// SET tasks assign variables in workflow state.
type SetTaskConfig struct {
    // Variables to set in workflow state.
    // Keys are variable names, values can be literals or expressions.
    Variables map[string]string `json:"variables" validate:"required"`
}

// ‚ùå BAD - Obvious it's generated
// Generated struct for set_task_config
type SetTaskConfig struct {
    field1 map[string]string // auto-generated field
}
```

---

### 2. Templates Should Be Simple and Maintainable

**Goal**: Future developers (including AI agents) should be able to modify templates easily.

**Guidelines**:
- ‚úÖ Use Go's `text/template` (standard library)
- ‚úÖ One template per output type (structs, builders, conversions)
- ‚úÖ Keep template logic minimal (move complex logic to generator)
- ‚úÖ Add comments in templates explaining non-obvious sections
- ‚úÖ Test templates independently

**Template Structure**:

```
tools/codegen/templates/
‚îú‚îÄ‚îÄ config_struct.tmpl      # Generates config structs
‚îú‚îÄ‚îÄ builder.tmpl            # Generates builder functions
‚îú‚îÄ‚îÄ proto_conversion.tmpl   # Generates ToProto/FromProto
‚îî‚îÄ‚îÄ validation.tmpl         # Generates validation helpers
```

---

### 3. Schema is the Source of Truth

**Goal**: All generation decisions come from schema, not hardcoded logic.

**Guidelines**:
- ‚úÖ Schema defines field types, validations, documentation
- ‚úÖ Generator reads schema, applies templates
- ‚úÖ No "special case" hardcoding in generator
- ‚úÖ Add to schema if behavior needs to differ

**Schema Example**:

```json
{
  "taskTypes": {
    "SET": {
      "name": "SetTaskConfig",
      "description": "Defines the configuration for SET tasks.",
      "fields": [
        {
          "name": "Variables",
          "type": "map[string]string",
          "required": true,
          "description": "Variables to set in workflow state."
        }
      ]
    }
  }
}
```

---

### 4. Fail Fast with Clear Errors

**Goal**: Generator should catch issues early with helpful messages.

**Guidelines**:
- ‚úÖ Validate schema before generation
- ‚úÖ Provide clear error messages (not "invalid input")
- ‚úÖ Include schema location in errors
- ‚úÖ Exit with non-zero code on errors
- ‚úÖ Don't generate partial/broken code

**Example Errors**:

```
‚ùå BAD:
Error: invalid field

‚úÖ GOOD:
Error in schema 'workflow_tasks.json', task 'HTTP_CALL', field 'method':
  Field type 'invalid_type' is not supported.
  Supported types: string, int, bool, map, array, object
  Location: line 42, column 12
```

---

### 5. Backward Compatibility Matters

**Goal**: Don't break existing SDK code without migration path.

**Guidelines**:
- ‚úÖ Generate code in separate `gen/` packages initially
- ‚úÖ Provide compatibility wrappers for old APIs
- ‚úÖ Document breaking changes clearly
- ‚úÖ Offer automated migration tools if possible
- ‚úÖ Support gradual migration (not big bang)

---

### 6. Test Generated Code Automatically

**Goal**: Generator should produce working code, verified by tests.

**Guidelines**:
- ‚úÖ Run `go build` on generated packages
- ‚úÖ Run `go test` on generated packages
- ‚úÖ Include unit tests for generated helpers
- ‚úÖ Test proto round-trip (SDK ‚Üí proto ‚Üí SDK)
- ‚úÖ Test validation logic

**Test Structure**:

```
tools/codegen/generator_test.go     # Tests generator logic
sdk/go/workflow/gen/gen_test.go     # Tests generated workflow code
sdk/go/agent/gen/gen_test.go        # Tests generated agent code
```

---

### 7. Documentation is Generated Too

**Goal**: Code comments should be informative and consistent.

**Guidelines**:
- ‚úÖ Generate godoc comments for all exported types
- ‚úÖ Include examples in documentation
- ‚úÖ Reference proto definitions in comments
- ‚úÖ Link to related types/functions
- ‚úÖ Mark generated code clearly

**Documentation Header**:

```go
// Code generated by stigmer-codegen. DO NOT EDIT.
// Source: apis/ai/stigmer/agentic/workflow/v1/tasks/set.proto

package gen

// SetTaskConfig defines the configuration for SET tasks.
//
// SET tasks assign variables in workflow state.
//
// Example:
//   cfg := &SetTaskConfig{
//       Variables: map[string]string{
//           "name": "value",
//       },
//   }
//
// See: ai.stigmer.agentic.workflow.v1.tasks.SetTaskConfig (proto)
type SetTaskConfig struct {
    // ...
}
```

---

### 8. Performance is Important (But Not Critical)

**Goal**: Generator should be fast, but correctness > speed.

**Guidelines**:
- ‚úÖ Cache expensive operations (proto parsing)
- ‚úÖ Parallelize independent template rendering
- ‚úÖ Don't regenerate unchanged files
- ‚úÖ Profile if generation takes > 10 seconds
- ‚ùå Don't optimize prematurely

**Acceptable Performance**:
- Full regeneration: < 10 seconds
- Incremental regeneration: < 2 seconds
- Single task type: < 500ms

---

### 9. Follow Pulumi's Patterns (Our North Star)

**Goal**: Leverage proven patterns from Pulumi.

**What to Adopt**:
- ‚úÖ Schema as intermediate representation
- ‚úÖ Template-based generation
- ‚úÖ Separation of concerns (parser, generator, templates)
- ‚úÖ Generated code structure
- ‚úÖ Error handling patterns

**What to Adapt**:
- üîÑ Stigmer-specific task types (not Pulumi resources)
- üîÑ Workflow-specific concepts (TaskFieldRef, etc.)
- üîÑ Simpler schema format (we don't need all Pulumi features)

**Reference**:
- Pulumi codegen: `/Users/suresh/scm/github.com/pulumi/pulumi/pkg/codegen/`

---

### 10. Make It Easy to Add New Task Types

**Goal**: Demonstrate the value by making additions trivial.

**Target Workflow**:

```bash
# 1. Define proto
vim apis/ai/stigmer/agentic/workflow/v1/tasks/new_task.proto

# 2. Run generator
make codegen

# 3. Done! Generated code ready to use.
```

**Checklist for New Task Types**:
- [ ] Proto definition exists
- [ ] Proto is valid (buf lint)
- [ ] Run codegen
- [ ] Generated code compiles
- [ ] Write example using new task
- [ ] Tests pass

---

## Anti-Patterns to Avoid

### ‚ùå Don't: Hardcode Task-Specific Logic

```go
// BAD - Special case in generator
if taskType == "HTTP_CALL" {
    // Custom handling
}
```

Instead: Add to schema or make template flexible.

### ‚ùå Don't: Generate Ugly Code

```go
// BAD - Unformatted, unclear
type T struct{F1 string;F2 int}
func(t*T)M()error{return nil}
```

Instead: Use `gofmt`, meaningful names, proper spacing.

### ‚ùå Don't: Silently Ignore Errors

```go
// BAD
err := generateCode()
if err != nil {
    log.Println("warning:", err)
    // Continue anyway
}
```

Instead: Fail fast with clear messages.

### ‚ùå Don't: Break Existing Code

```go
// BAD - Remove old API without deprecation
// Old: wf.SetVars()
// New: wf.Set() (no migration path!)
```

Instead: Deprecate gradually, provide compatibility layer.

---

## Code Review Checklist

Before merging generated code:

- [ ] Generated code is formatted (`gofmt`, `goimports`)
- [ ] All generated code compiles
- [ ] Tests pass (existing + new)
- [ ] Documentation is complete
- [ ] No hardcoded special cases
- [ ] Error messages are clear
- [ ] Performance is acceptable
- [ ] Examples use new generated code
- [ ] Migration guide updated (if breaking changes)

---

## Future Considerations

### Multi-Language Support

When we add Python/TypeScript SDKs:
- Same schema drives all languages
- Language-specific templates
- Shared validation logic

### Advanced Features

Potential future enhancements:
- Schema validation (buf validate integration)
- Custom field types (e.g., Duration, URL)
- Code generation hooks (pre/post processing)
- Incremental generation (only changed files)

---

**Remember**: The best code generator is one that developers trust and don't need to think about.
