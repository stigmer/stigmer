# Simplify CLI Commands - Server Pattern

**Date**: 2026-01-20  
**Type**: Refactor (User-Facing)  
**Scope**: CLI Commands  
**Impact**: Breaking Change (Command Restructure)

## Summary

Simplified Stigmer CLI from 8 commands to 2 command groups by:
1. Removing redundant `init` command (auto-initialization now happens in `server`)
2. Renaming `local` → `server` (clearer, matches industry patterns like `temporal server`)
3. Removing premature `agent` and `workflow` CRUD commands (will use UI/API instead)
4. Removing unimplemented `version` command
5. Keeping `completion` (auto-generated by Cobra, useful for shell completion)

Result: Clean, focused CLI that manages server lifecycle, not resources.

## Problem

The CLI had too many commands with overlapping purposes:
- **Init vs Local**: Both could start the daemon - confusing UX
- **Agent/Workflow CRUD**: Premature - users should use UI/API, not CLI flags
- **Version**: Not properly implemented (no build-time version injection)
- **Unclear naming**: "local" doesn't clearly communicate "start the server"

User feedback: "Too many commands. Why `stigmer init` AND `stigmer local`?"

## What Changed

### Commands Removed

**`stigmer init`**
- **Why**: Redundant with `local start`, caused confusion
- **Replaced by**: Auto-initialization in `stigmer server` (first-run detection)
- **Migration**: `stigmer init` → `stigmer server` (auto-initializes)

**`stigmer agent` (create/list/get/delete)**
- **Why**: Premature optimization - users should use UI/API for resource management
- **Replaced by**: Temporal UI (http://localhost:8233) + future YAML-based config
- **Migration**: Use Temporal UI or API directly

**`stigmer workflow` (create/list/get/delete)**
- **Why**: Same as agent - premature CLI-based CRUD
- **Replaced by**: Temporal UI + future YAML-based config
- **Migration**: Use Temporal UI or API directly

**`stigmer version`**
- **Why**: Not properly implemented (no version injection)
- **Replaced by**: Will add `--version` flag in future if needed
- **Migration**: Check GitHub releases

### Commands Renamed

**`stigmer local` → `stigmer server`**
- **Why**: 
  - "local" is vague (local what?)
  - "server" clearly communicates "start the Stigmer server"
  - Matches industry patterns (`temporal server start-dev`, `redis-server`)
- **Breaking change**: Yes
- **Migration**:
  - `stigmer local` → `stigmer server`
  - `stigmer local start` → `stigmer server` (implicit start)
  - `stigmer local stop` → `stigmer server stop`
  - `stigmer local status` → `stigmer server status`
  - `stigmer local restart` → `stigmer server restart`

### Commands Kept

**`stigmer backend`** (status/set)
- **Why**: Still needed for switching between local/cloud backends
- **No changes**: Works the same, updated help text to reference `stigmer server`

**`stigmer completion`** (auto-generated by Cobra)
- **Why**: Useful for shell tab-completion
- **No changes**: Standard Cobra feature

## Implementation Details

### File Changes

**Deleted**:
- `client-apps/cli/cmd/stigmer/root/init.go` (99 lines) - One-time initialization
- `client-apps/cli/cmd/stigmer/root/local.go` (204 lines) - Daemon management
- `client-apps/cli/cmd/stigmer/root/agent.go` (212 lines) - Agent CRUD
- `client-apps/cli/cmd/stigmer/root/workflow.go` (192 lines) - Workflow CRUD
- `client-apps/cli/cmd/stigmer/root/version.go` (22 lines) - Version display

**Created**:
- `client-apps/cli/cmd/stigmer/root/server.go` (213 lines) - Unified server management with auto-init

**Updated**:
- `client-apps/cli/cmd/stigmer/root.go` - Only register `server` and `backend` commands
- `client-apps/cli/cmd/stigmer/root/backend.go` - Reference `stigmer server` in help text
- `client-apps/cli/internal/cli/clierr/clierr.go` - Error messages reference `stigmer server`
- `client-apps/cli/COMMANDS.md` - Complete rewrite with new structure
- `client-apps/cli/README.md` - Updated quick start and examples
- `client-apps/cli/Makefile` - Updated help text and examples

### Auto-Initialization Logic

**Before** (required two steps):
```bash
stigmer init      # Create config, start daemon
stigmer local     # Or is this how you start?
```

**After** (single step with auto-init):
```go
func handleServerStart() {
    // Auto-initialize config if needed
    if !config.IsInitialized() {
        cliprint.PrintInfo("First-time setup: Initializing Stigmer...")
        cfg := config.GetDefault()
        config.Save(cfg)
        cliprint.PrintSuccess("Created configuration...")
    }
    
    // Start server
    daemon.StartWithOptions(dataDir, options)
}
```

**Result**: Just run `stigmer server` - it auto-initializes on first run.

### Help Text Consistency

**Error messages** updated to reference new commands:
```go
// Before
fmt.Fprintf(os.Stderr, "  stigmer local start\n")

// After
fmt.Fprintf(os.Stderr, "  stigmer server\n")
```

**Backend command** help updated:
```bash
# Before
stigmer local status
stigmer local start

# After
stigmer server status
stigmer server
```

## UX Improvements

### 1. Simpler Mental Model

**Before**: "Do I run `init` or `local`? What's the difference?"
**After**: "Just run `stigmer server` to start"

### 2. Industry-Standard Pattern

Matches patterns users already know:
- `temporal server start-dev` (Temporal)
- `redis-server` (Redis)
- `postgres -D data` (PostgreSQL)
- `minikube start` (Minikube)

### 3. Reduced Command Count

**Before**: 8 top-level commands (overwhelming)
- init, local, backend, agent, workflow, version, completion, help

**After**: 4 top-level commands (focused)
- server, backend, completion, help

### 4. Clear Responsibility Separation

**CLI Purpose**: Server lifecycle management
- Start/stop/status/restart server
- Configure backend (local vs cloud)

**NOT CLI Purpose**: Resource CRUD
- Use Temporal UI for agents/workflows
- Future: YAML-based declarative config (`stigmer apply -f agent.yaml`)

## Migration Guide

### For Existing Users

**Starting the server**:
```bash
# Before
stigmer init           # First time only
stigmer local start    # Regular usage

# After
stigmer server         # Works every time (auto-initializes)
```

**Stopping the server**:
```bash
# Before
stigmer local stop

# After
stigmer server stop
```

**Checking status**:
```bash
# Before
stigmer local status

# After
stigmer server status
```

**Creating agents/workflows**:
```bash
# Before
stigmer agent create --name bot --instructions "..."

# After
# Use Temporal UI: http://localhost:8233
# Or wait for: stigmer apply -f agent.yaml (future)
```

### Breaking Changes

**⚠️ ALL `local` commands are now `server` commands**

This is an intentional breaking change to improve UX. Since Stigmer is in early development, now is the right time to get the CLI structure right.

**Update scripts**:
```bash
# Find and replace in your scripts
sed -i 's/stigmer local/stigmer server/g' *.sh

# Or update manually:
stigmer local → stigmer server
stigmer local start → stigmer server
stigmer local stop → stigmer server stop
```

## Testing

**Build verification**:
```bash
cd client-apps/cli
go build -o /tmp/stigmer .  # ✅ Builds successfully
```

**Command verification**:
```bash
stigmer --help
# Shows: server, backend, completion, help

stigmer server --help
# Shows: restart, status, stop (and default start action)

stigmer backend --help
# Shows: set, status
```

**Error message verification**:
- Connection errors now suggest `stigmer server` instead of `stigmer local start`
- Backend configuration references `stigmer server` in examples

## Documentation Updates

All documentation updated to reflect new commands:

**User-facing**:
- `COMMANDS.md` - Complete rewrite with new command structure
- `README.md` - Updated quick start and all examples
- `Makefile` - Updated help text and quick-start instructions

**Internal**:
- Error handlers reference new commands
- Help text consistent across all commands
- Examples use `stigmer server` pattern

## Design Rationale

### Why "server" instead of "local"?

**Clarity**: "server" clearly communicates what's being started
- ✅ User knows: "I'm starting the Stigmer server"
- ❌ "Local" is ambiguous: local what? local mode? local daemon?

**Industry precedent**: Matches familiar patterns
- Temporal: `temporal server start-dev`
- Docker: `dockerd` (docker daemon)
- PostgreSQL: `postgres` (start server)

**Future-proof**: Works with cloud mode too
- `stigmer server` (local mode by default)
- `stigmer server --cloud` (future: cloud mode)

### Why remove agent/workflow commands?

**Premature optimization**: CLI flags are cumbersome for CRUD
- ❌ `stigmer agent create --name X --instructions Y --model Z --temperature 0.7 ...`
- ✅ Edit `agents/my-agent.yaml` and run `stigmer apply -f agents/`

**Better UX exists**: Temporal UI is already available
- Real-time execution visibility
- Workflow history and debugging
- No CLI needed for development

**Declarative is better**: YAML-based config coming soon
- Version-controlled agent definitions
- Review changes in PRs
- Apply entire agent configs at once

### Why auto-initialize instead of separate init?

**Reduces friction**: One less step for new users
- ❌ "First run `init`, then run `local start`... or is it `local` without args?"
- ✅ "Just run `stigmer server`"

**Common pattern**: Most tools auto-initialize
- Git: Creates .git automatically
- Docker: Creates config on first run
- Kubernetes: kubectl creates ~/.kube/config

**First-run detection is easy**:
```go
if !config.IsInitialized() {
    initializeConfig()
}
startServer()
```

## Impact Assessment

### User Impact: Medium (Breaking Changes)

**Who**: Early adopters using Stigmer CLI in scripts
**What**: Commands renamed, some removed
**Mitigation**: 
- Clear migration guide provided
- Simple find-replace in scripts
- Better UX long-term

### Developer Impact: Low (Cleaner Codebase)

**What changed**:
- Deleted 729 lines of command code
- Added 213 lines of unified server command
- Net: -516 lines of code

**Benefits**:
- Fewer commands to maintain
- Clearer separation of concerns (server vs resources)
- Room for future features (YAML-based config)

### Documentation Impact: Medium (Comprehensive Updates)

**Updated**:
- All CLI documentation (COMMANDS.md, README.md)
- All help text and examples
- Makefile quick-start instructions
- Error messages

**Benefit**: Consistent documentation that matches new structure

## Future Work

### Phase 1: Server Lifecycle (✅ This PR)
- Start/stop/status/restart server
- Backend configuration
- Auto-initialization

### Phase 2: Declarative Config (Planned)
```bash
stigmer apply -f agent.yaml
stigmer apply -f workflows/
stigmer delete -f agent.yaml
```

### Phase 3: Execution (Planned)
```bash
stigmer exec agent my-bot "analyze this"
stigmer exec workflow onboarding --input user.yaml
```

### Phase 4: Advanced (Future)
```bash
stigmer logs agent my-bot
stigmer debug workflow failed-run
stigmer export agents > backup.yaml
```

## Lessons Learned

### 1. Get CLI structure right early

Changing commands later is painful (breaking changes). Better to:
- Start with minimal focused commands
- Add features incrementally
- Learn from industry patterns

### 2. Declarative > Imperative for CRUD

CLI flags for CRUD are cumbersome:
- Hard to remember all flags
- Can't version-control
- Can't review in PRs

YAML-based config is better:
- Edit in your favorite editor
- Review changes in Git
- Apply entire configurations

### 3. Auto-initialization reduces friction

Don't make users run separate init steps:
- Check if initialized
- Initialize if needed
- Proceed with actual work

One command is better than two.

### 4. Clear naming matters

"local" was confusing - what does local mean?
"server" is obvious - you're starting a server.

Spend time on naming. It affects UX forever.

## Related Changes

**This changelog entry**:
- Tracks the CLI refactoring for version history
- Captures implementation details and decisions
- Serves as reference for future debugging

**Product documentation** (separate):
- Updated `COMMANDS.md` for command reference
- Updated `README.md` for quick-start guide
- Both serve different purposes (change tracking vs usage/understanding)

## References

- **Industry patterns**: 
  - Temporal: `temporal server start-dev`
  - Redis: `redis-server`
  - PostgreSQL: `postgres -D data`
  - Minikube: `minikube start`

- **CLI best practices**:
  - Auto-initialization (Git, Docker, kubectl)
  - Declarative config (Kubernetes, Terraform, Pulumi)
  - Focused commands (do one thing well)

- **Cobra documentation**:
  - Command structure patterns
  - Auto-generated completion
  - Help text conventions

---

**Changes committed**: Will be committed by completion workflow  
**Documentation updated**: COMMANDS.md, README.md, Makefile, help text  
**Migration impact**: Breaking change, but simple to migrate (find-replace)  
**Long-term benefit**: Cleaner, more intuitive CLI that scales better

**Next steps**: 
1. Monitor user feedback on new command structure
2. Plan YAML-based declarative config (Phase 2)
3. Consider adding `--version` flag if version injection is implemented
