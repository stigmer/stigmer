# Environment Controller

Go implementation of Environment resource CRUD handlers for Stigmer OSS.

## Overview

The Environment controller manages environment resources, which represent named collections of configuration and secrets. Environments are created before AgentInstance or WorkflowInstance and referenced during instance creation.

## Architecture

Following the same pattern as Agent controller:
- **Pipeline-based**: All operations use the request pipeline pattern
- **Reusable steps**: Common steps shared across all API resources
- **Simplified from Cloud**: No IAM/FGA, authorization, or event publishing (OSS is single-user)

## Handler Implementation

### Controller Structure

```go
type EnvironmentController struct {
    environmentv1.UnimplementedEnvironmentCommandControllerServer
    environmentv1.UnimplementedEnvironmentQueryControllerServer
    store *badger.Store
}
```

### Implemented Operations

| Operation | File | Pipeline Steps | Description |
|-----------|------|----------------|-------------|
| **Create** | `create.go` | ValidateProto → ResolveSlug → CheckDuplicate → BuildNewState → Persist | Create new environment |
| **Update** | `update.go` | ValidateProto → ResolveSlug → LoadExisting → BuildUpdateState → Persist | Update existing environment |
| **Delete** | `delete.go` | ValidateProto → ExtractResourceId → LoadExistingForDelete → DeleteResource | Delete environment by ID |
| **Get** | `get.go` | ValidateProto → LoadTarget | Retrieve environment by ID |
| **GetByReference** | `get_by_reference.go` | ValidateProto → LoadByReference | Retrieve environment by slug |
| **Apply** | `apply.go` | ValidateProto → ResolveSlug → LoadForApply → (delegate to Create or Update) | Declarative create-or-update |

### Differences from Stigmer Cloud (Java)

The Go implementation excludes enterprise features:

| Feature | Stigmer Cloud (Java) | Stigmer OSS (Go) | Reason |
|---------|---------------------|------------------|---------|
| **Authorization** | ✅ FGA-based permissions | ❌ Excluded | OSS is single-user |
| **IAM Policies** | ✅ CreateIamPolicies step | ❌ Excluded | No IAM system in OSS |
| **Event Publishing** | ✅ Publish step | ❌ Excluded | No event bus in OSS |
| **Response Transforms** | ✅ TransformResponse step | ❌ Excluded | Not needed for local usage |

## Pipeline Steps Used

All steps are reusable from `backend/libs/go/grpc/request/pipeline/steps/`:

- **ValidateProtoStep** - Validates buf.validate constraints
- **ResolveSlugStep** - Generates slug from metadata.name
- **CheckDuplicateStep** - Prevents duplicate slugs
- **BuildNewStateStep** - Sets ID, timestamps, audit fields for create
- **BuildUpdateStateStep** - Merges spec, updates timestamps for update
- **PersistStep** - Saves resource to BadgerDB
- **LoadExistingStep** - Loads resource for update
- **LoadExistingForDeleteStep** - Loads resource before deletion
- **LoadTargetStep** - Loads resource for get operations
- **LoadByReferenceStep** - Loads resource by slug
- **LoadForApplyStep** - Checks existence for apply operations
- **ExtractResourceIdStep** - Extracts ID from wrapper types
- **DeleteResourceStep** - Deletes resource from database

## Registration

The controller is registered in `cmd/server/main.go`:

```go
environmentController := environmentcontroller.NewEnvironmentController(store)
environmentv1.RegisterEnvironmentCommandControllerServer(grpcServer, environmentController)
environmentv1.RegisterEnvironmentQueryControllerServer(grpcServer, environmentController)
```

## File Organization

```
environment/
├── environment_controller.go    # Controller struct + constructor (18 lines)
├── create.go                    # Create handler + pipeline (49 lines)
├── update.go                    # Update handler + pipeline (45 lines)
├── delete.go                    # Delete handler + pipeline (55 lines)
├── get.go                       # Get handler + pipeline (43 lines)
├── get_by_reference.go          # GetByReference handler + pipeline (45 lines)
├── apply.go                     # Apply handler + pipeline (63 lines)
├── BUILD.bazel                  # Bazel build file (auto-generated by Gazelle)
└── README.md                    # This file
```

All files are well under the 100-line ideal threshold.

## Implementation Notes

### No Custom Steps Required

Unlike Agent controller (which has `CreateDefaultInstanceStep` and `UpdateAgentStatusStep`), Environment has no domain-specific business logic beyond standard CRUD operations. All steps are generic and reusable.

### Owner Scope Validation

Environment resources enforce owner scope restrictions via proto validation:
- ✅ Allowed: `organization` or `identity_account` scope
- ❌ Forbidden: `platform` scope (enforced by buf.validate CEL rule)

This validation happens automatically in the ValidateProtoStep.

### No Dependencies on Other Services

Environment controller only depends on BadgerDB store - no downstream clients needed (unlike Agent which depends on AgentInstance client).

## Testing

The controller compiles successfully:

```bash
cd /Users/suresh/scm/github.com/stigmer/stigmer
go build ./backend/services/stigmer-server/pkg/controllers/environment/...
# Exit code: 0 ✅
```

## Next Steps

To test the environment handlers:

1. **Start the server**: `go run ./backend/services/stigmer-server/cmd/server`
2. **Create an environment**: Use gRPC client to call `EnvironmentCommandController.create()`
3. **Query environments**: Use gRPC client to call `EnvironmentQueryController.get()` or `getByReference()`

## Alignment with Implementation Rules

This implementation follows `@implement-stigmer-oss-handlers.mdc`:

✅ **Pipeline Pattern**: ALL handlers use pipelines (mandatory)  
✅ **Domain Package Pattern**: Separate package at `controllers/environment/`  
✅ **File-per-Handler**: Each operation in its own file  
✅ **File Size**: All files < 100 lines (ideal: 50-150 lines)  
✅ **Reusable Steps**: All steps from common library  
✅ **No IAM/FGA**: Excluded enterprise-only features  
✅ **Error Handling**: Uses grpclib helpers  
✅ **Documentation**: Comprehensive comments in each handler  

## Related Documentation

- [Agent Controller](../agent/README.md) - Similar pattern reference
- [Pipeline Architecture](../../../../../libs/go/grpc/request/pipeline/README.md)
- [Implementation Rules](../../../_rules/implement-stigmer-oss-handlers/implement-stigmer-oss-handlers.mdc)
