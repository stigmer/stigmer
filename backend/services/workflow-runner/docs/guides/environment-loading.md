# Environment Variable Loading Strategy

## Overview

Environment variables for the workflow-runner service are loaded **outside of the application code** using shell scripts and run configurations. This keeps the Go code clean and follows the pattern used by other services in the Planton monorepo.

## Why This Approach?

- **Separation of concerns**: Application code should read env vars, not manage `.env` files
- **Consistency**: Matches the pattern used by iac-runner and other Go services
- **Flexibility**: Easy to switch between local dev, testing, and production environments
- **No dependencies**: No need for godotenv or other .env loading libraries

## How It Works

### 1. Generate `.env` Files

Before running the service locally, generate environment variables:

```bash
# Run from repo root
./bazelw run //backend/services/workflow-runner:dot_env_local
```

This creates two files in `backend/services/workflow-runner/`:
- `.env` - Simple `KEY=value` format
- `.env_export` - Shell export format (`export KEY=value`)

### 2. Run the Service

#### Option A: Using Makefile

```bash
cd backend/services/workflow-runner

# Run the gRPC server
make run-grpc

# Run the worker
make run-worker
```

The Makefile targets source `.env_export` before running:
```makefile
run-grpc:
	. .env_export && go run ./cmd/grpc-server/main.go
```

#### Option B: Using IntelliJ Run Configuration

Use the `workflow-runner.launch` run configuration in IntelliJ/GoLand.

This executes `backend/services/workflow-runner/scripts/run-with-env.sh`, which:
1. Finds the repo root
2. Sources `.env_export` 
3. Runs `bazelw run //backend/services/workflow-runner:workflow_runner`

#### Option C: Manually

```bash
# From service directory
cd backend/services/workflow-runner
. .env_export && go run ./cmd/grpc-server/main.go

# Or from repo root
cd /path/to/stigmer
. backend/services/workflow-runner/.env_export && ./bazelw run //backend/services/workflow-runner:workflow_runner
```

## File Locations

```
backend/services/workflow-runner/
├── .env                     # Generated by dot_env_local (gitignored)
├── .env_export              # Generated by dot_env_local (gitignored)
├── scripts/
│   └── run-with-env.sh     # Helper script for run configurations
└── Makefile                 # Contains run-grpc and run-worker targets
```

## Run Configuration Details

The IntelliJ run configuration (`/.run/workflow-runner.launch.run.xml`) is configured as a shell script that:

- **Type**: ShConfigurationType (not BazelRunConfigurationType)
- **Script**: `$PROJECT_DIR$/backend/services/workflow-runner/scripts/run-with-env.sh`
- **Working Dir**: `$PROJECT_DIR$` (repo root)
- **Executes in terminal**: Yes

This provides a clean, visual way to run the service with proper environment variables loaded.

## Production Deployment

In production (Kubernetes):
- Environment variables come from ConfigMaps and Secrets
- No `.env` files are used or needed
- The application simply reads from `os.Getenv()` as normal

## Comparison with Other Services

This matches the pattern used by **iac-runner**:

**iac-runner Makefile:**
```makefile
run:
	. .env_export;go run main.go
```

**workflow-runner Makefile:**
```makefile
run-grpc:
	. .env_export && go run ./cmd/grpc-server/main.go
```

Both services keep environment loading at the execution layer, not in the code.

## Troubleshooting

### Error: "STIGMER_SERVICE_ENDPOINT environment variable is required"

**Cause**: `.env_export` file hasn't been generated or sourced.

**Solution**:
```bash
# Generate the .env files
./bazelw run //backend/services/workflow-runner:dot_env_local

# Then run via Makefile or run configuration
cd backend/services/workflow-runner
make run-grpc
```

### Error: ".env_export not found"

**Cause**: Running from wrong directory or file not generated.

**Solution**:
1. Ensure you've generated the env files (see above)
2. Check that the file exists: `ls -la backend/services/workflow-runner/.env_export`

### Variables Not Loading in IDE

**Cause**: Using the old Bazel run configuration instead of the shell script.

**Solution**: Use the updated `workflow-runner.launch` run configuration which uses `run-with-env.sh`.

## Summary

- ✅ **Generate** env files with `bazel run //backend/services/workflow-runner:dot_env_local`
- ✅ **Run** using Makefile (`make run-grpc`) or IntelliJ run configuration
- ✅ **Code** stays clean - no env file loading logic
- ✅ **Production** uses Kubernetes ConfigMaps/Secrets
