apiVersion: kubernetes.project-planton.org/v1
kind: KubernetesDeployment
metadata:
  name: agent-runner
  org: stigmer
  labels:
    project-planton.org/provisioner: pulumi
    pulumi.project-planton.org/organization: stigmer
    pulumi.project-planton.org/project: stigmer
    kubernetes.project-planton.org/docker-config-json-file: "~/scm/github.com/leftbin/stigmer-cloud/ops/platform/service-deployments/files/docker-config.ghcr.json"
spec:
  container:
    app:
      image:
        repo: ghcr.io/leftbin/stigmer-cloud/backend/services/agent-runner
        #tag: <comes-from-ci-git-commit-sha>
      env:
        variables:
          # Temporal Configuration
          # Polyglot setup: Python activities on agent_execution_runner, Java workflows on agent_execution_stigmer
          TEMPORAL_NAMESPACE:
            value: $variables-group/stigmer-temporal-config/namespace
          TEMPORAL_AGENT_EXECUTION_RUNNER_TASK_QUEUE:
            value: agent_execution_runner
          TEMPORAL_MAX_CONCURRENCY:
            value: "10"
          # Stigmer Backend Configuration
          STIGMER_BACKEND_ENDPOINT:
            value: localhost:8080
          # Redis Configuration
          REDIS_PORT:
            value: $variables-group/stigmer-redis-config/port
          # Auth0 Configuration
          AUTH0_DOMAIN:
            value: $variables-group/stigmer-auth0-config/prod.domain
          AUTH0_AUDIENCE:
            value: $variables-group/stigmer-auth0-config/prod.api-audience
          # Daytona Configuration
          DAYTONA_DEV_TOOLS_SNAPSHOT_ID:
            value: $variables-group/daytona/dev-tools-snapshot-id
          # Logging
          LOG_LEVEL:
            value: INFO
      resources:
        limits:
          cpu: 1000m
          memory: 2Gi
        requests:
          cpu: 100m
          memory: 256Mi
  availability:
    minReplicas: 1
    horizontalPodAutoscaling:
      isEnabled: false
  version: main
