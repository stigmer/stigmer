# Stigmer Distribution Strategy

This document explains how Stigmer CLI and Server are packaged and distributed together.

## Overview

Stigmer consists of two binaries that work together:
- **`stigmer`** - CLI tool for users
- **`stigmer-server`** - Backend server (automatically started by `stigmer local`)

Both binaries must be distributed together to provide a seamless user experience.

## Distribution Methods

### 1. Homebrew (macOS/Linux) - RECOMMENDED

**Installation:**
```bash
brew install stigmer/tap/stigmer
```

**What it installs:**
- `stigmer` CLI → `/opt/homebrew/bin/stigmer`
- `stigmer-server` → `/opt/homebrew/bin/stigmer-server`

**Configuration:**
The Homebrew formula is auto-generated by GoReleaser from `.goreleaser.yml`.

### 2. Shell Script (All Platforms)

**Installation:**
```bash
curl -fsSL https://raw.githubusercontent.com/stigmer/stigmer/main/scripts/install.sh | bash
```

**What it does:**
1. Detects your OS and architecture
2. Downloads the latest release tarball from GitHub
3. Extracts both binaries
4. Installs to `~/bin/` (or custom `$INSTALL_DIR`)

**Manual download:**
```bash
# Download specific version
VERSION=v0.1.0
OS=darwin  # or linux, windows
ARCH=amd64 # or arm64

curl -LO "https://github.com/stigmer/stigmer/releases/download/$VERSION/stigmer_${VERSION}_${OS}_${ARCH}.tar.gz"
tar -xzf "stigmer_${VERSION}_${OS}_${ARCH}.tar.gz"
sudo mv stigmer stigmer-server /usr/local/bin/
```

### 3. GitHub Releases

Each release contains platform-specific archives with both binaries:

```
stigmer_0.1.0_Darwin_x86_64.tar.gz    # macOS Intel
stigmer_0.1.0_Darwin_arm64.tar.gz     # macOS Apple Silicon
stigmer_0.1.0_Linux_x86_64.tar.gz     # Linux AMD64
stigmer_0.1.0_Linux_arm64.tar.gz      # Linux ARM64
stigmer_0.1.0_Windows_x86_64.zip      # Windows AMD64
```

Each archive contains:
- `stigmer` (or `stigmer.exe` on Windows)
- `stigmer-server` (or `stigmer-server.exe`)
- `README.md`
- `LICENSE`

### 4. Auto-Download Fallback (Built-in)

If `stigmer-server` is missing when running `stigmer local`, the CLI can automatically:
1. Detect it's missing
2. Download the matching version from GitHub releases
3. Install to `~/.stigmer/bin/stigmer-server`
4. Use it automatically

**Note:** This is a fallback mechanism. Primary distribution should always include both binaries.

## Binary Discovery

The `stigmer` CLI searches for `stigmer-server` in this order:

1. **`$STIGMER_SERVER_BIN`** - Explicit path (for testing/development)
2. **Same directory as CLI** - Standard installation
3. **Development paths** - For building from source
   - `bin/stigmer-server`
   - `bazel-bin/backend/services/stigmer-server/...`
4. **Auto-download** - Last resort (if enabled)

## Release Process

### Creating a New Release

1. **Tag the release:**
   ```bash
   git tag -a v0.1.0 -m "Release v0.1.0"
   git push origin v0.1.0
   ```

2. **GoReleaser automatically:**
   - Builds both binaries for all platforms
   - Creates GitHub release with all archives
   - Updates Homebrew tap
   - Generates changelog
   - Creates Docker images (optional)

3. **GitHub Actions workflow** (`.github/workflows/release.yml`):
   ```yaml
   name: Release
   on:
     push:
       tags:
         - 'v*'
   
   jobs:
     goreleaser:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v3
         - uses: actions/setup-go@v4
         - uses: goreleaser/goreleaser-action@v5
           with:
             version: latest
             args: release --clean
           env:
             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   ```

### Local Testing

Before releasing, test the packaging locally:

```bash
# Build without releasing
goreleaser build --snapshot --clean

# Test archives
goreleaser release --snapshot --clean --skip-publish
```

## Platform-Specific Notes

### macOS

**Homebrew (recommended):**
```bash
brew install stigmer/tap/stigmer
```

**Manual installation:**
Both binaries must be in `$PATH`. Standard locations:
- `/usr/local/bin/` (Intel)
- `/opt/homebrew/bin/` (Apple Silicon)

**Code signing:**
For distribution outside Homebrew, binaries should be code-signed:
```bash
codesign --sign "Developer ID Application: Your Name" stigmer
codesign --sign "Developer ID Application: Your Name" stigmer-server
```

### Linux

**Package managers:**
- **Homebrew:** `brew install stigmer/tap/stigmer`
- **Snap:** (TODO)
- **AppImage:** (TODO)

**Manual installation:**
```bash
sudo mv stigmer stigmer-server /usr/local/bin/
```

### Windows

**Scoop:** (TODO)
```powershell
scoop bucket add stigmer https://github.com/stigmer/scoop-bucket
scoop install stigmer
```

**Manual installation:**
1. Extract `stigmer_0.1.0_Windows_x86_64.zip`
2. Move `stigmer.exe` and `stigmer-server.exe` to `C:\Program Files\Stigmer\`
3. Add to PATH

## Development Workflow

For developers building from source:

```bash
# Install both binaries locally
make release-local

# Result:
#   ~/bin/stigmer
#   ~/bin/stigmer-server
```

Ensure `~/bin` is in your `$PATH`:
```bash
export PATH="$HOME/bin:$PATH"
```

## Continuous Integration

### Building Both Binaries

All CI builds must compile both binaries:

```yaml
# .github/workflows/ci.yml
- name: Build CLI
  run: go build -o bin/stigmer ./client-apps/cli

- name: Build Server
  run: go build -o bin/stigmer-server ./backend/services/stigmer-server/cmd/server

- name: Test CLI can find Server
  run: |
    export PATH="$PWD/bin:$PATH"
    stigmer local --help
```

### Testing Distribution

```yaml
- name: Test distribution
  run: |
    # Simulate user installation
    mkdir -p ~/.local/bin
    cp bin/stigmer ~/.local/bin/
    cp bin/stigmer-server ~/.local/bin/
    export PATH="$HOME/.local/bin:$PATH"
    stigmer local
```

## Troubleshooting

### "stigmer-server binary not found"

**Solution:**
1. Check if both binaries are installed:
   ```bash
   which stigmer
   which stigmer-server
   ```

2. If `stigmer-server` is missing:
   ```bash
   # Homebrew
   brew reinstall stigmer
   
   # Manual
   curl -fsSL https://raw.githubusercontent.com/stigmer/stigmer/main/scripts/install.sh | bash
   ```

3. For development:
   ```bash
   make release-local
   ```

### Version Mismatch

Always use matching versions of CLI and server:

```bash
stigmer --version
stigmer-server --version  # Should match
```

If versions don't match, reinstall both:
```bash
brew reinstall stigmer  # macOS
# or
curl -fsSL https://raw.githubusercontent.com/stigmer/stigmer/main/scripts/install.sh | bash
```

## Future Enhancements

### Planned Improvements

1. **Package managers:**
   - Snap (Linux)
   - Scoop (Windows)
   - Chocolatey (Windows)

2. **Docker images:**
   - `stigmer/stigmer-server:latest`
   - For server-only deployments

3. **Kubernetes operator:**
   - For multi-tenant cloud deployments

4. **Version pinning:**
   - CLI specifies required server version
   - Auto-downloads if mismatch

5. **Self-update:**
   ```bash
   stigmer update  # Updates both CLI and server
   ```

## Summary

✅ **Best practices:**
- Always distribute both binaries together
- Use GoReleaser for consistent releases
- Homebrew is the primary distribution method
- Shell script installer as fallback
- CLI auto-discovers server binary
- Development uses `make release-local`

✅ **Key files:**
- `.goreleaser.yml` - Release configuration
- `scripts/install.sh` - Shell installer
- `Makefile` (release-local) - Development builds

✅ **User experience:**
```bash
# One command to install
brew install stigmer/tap/stigmer

# One command to run
stigmer local

# It just works - no configuration needed
```
