# Stigmer Packaging & Distribution - Quick Summary

## The Problem

CLI depends on `stigmer-server` binary. How do we package and distribute both together?

## The Solution

### 1. Development (What We Just Fixed âœ…)

```bash
make release-local
```

**Result:**
- Builds both `stigmer` and `stigmer-server`
- Installs to `~/bin/stigmer` and `~/bin/stigmer-server`
- CLI automatically finds server in same directory

### 2. Production (Homebrew - Primary Method)

```ruby
# Formula: stigmer.rb (auto-generated by GoReleaser)
class Stigmer < Formula
  def install
    bin.install "stigmer"
    bin.install "stigmer-server"  # Both binaries!
  end
end
```

**User experience:**
```bash
brew install stigmer/tap/stigmer
# Installs both binaries to /opt/homebrew/bin/

stigmer local
# Works immediately - finds stigmer-server automatically
```

### 3. Production (Shell Script - Alternative)

```bash
curl -fsSL https://stigmer.io/install.sh | bash
```

**What it does:**
1. Detects OS/architecture
2. Downloads release tarball with BOTH binaries
3. Installs to `~/bin/` (or custom location)

### 4. GitHub Releases

Each release archive contains BOTH binaries:

```
stigmer_0.1.0_Darwin_arm64.tar.gz
â”œâ”€â”€ stigmer          â† CLI
â”œâ”€â”€ stigmer-server   â† Server
â”œâ”€â”€ README.md
â””â”€â”€ LICENSE
```

## How Binary Discovery Works

When you run `stigmer local`, it searches for `stigmer-server`:

```
1. $STIGMER_SERVER_BIN (env var - for testing)
2. Same directory as CLI (standard installation)
   âœ“ This works for Homebrew, manual installs, everything!
3. Development paths (bin/, bazel-bin/)
4. Auto-build (if in workspace)
5. (Future) Auto-download from GitHub
```

## Release Process

```bash
# 1. Tag release
git tag -a v0.1.0 -m "Release v0.1.0"
git push origin v0.1.0

# 2. GoReleaser (via GitHub Actions) automatically:
#    âœ“ Builds both binaries for all platforms
#    âœ“ Creates tarballs with both binaries
#    âœ“ Uploads to GitHub releases
#    âœ“ Updates Homebrew formula
#    âœ“ Publishes to brew tap
```

## Files Created

```
.goreleaser.yml          â† GoReleaser config (builds both binaries)
scripts/install.sh       â† Shell installer script
docs/DISTRIBUTION.md     â† Complete distribution guide
```

## Testing the Setup

### Test Local Development
```bash
make release-local
stigmer local
```

### Test Distribution Package
```bash
# Simulate what users get
goreleaser build --snapshot --clean
cd dist/stigmer_darwin_arm64/
ls -la
# Should see both: stigmer and stigmer-server
```

## Key Insights

âœ… **Single installation command** - User runs one command, gets both binaries
âœ… **Automatic discovery** - CLI finds server in same directory
âœ… **Zero configuration** - No environment variables needed
âœ… **Cross-platform** - Works on macOS, Linux, Windows
âœ… **Standard packaging** - Follows best practices for each platform

## Next Steps

1. **Set up GitHub Actions** for automated releases
2. **Create Homebrew tap** repository (`stigmer/homebrew-tap`)
3. **Test first release** with GoReleaser
4. **Add to official Homebrew** once stable (optional)

## Answer to Your Question

> "How will we package this and put it in Homebrew?"

**Answer:** 

1. **GoReleaser** builds both binaries and bundles them in one archive
2. **Homebrew formula** installs both binaries to the same directory
3. **CLI automatically finds** the server (same directory)
4. **User runs:** `brew install stigmer` â†’ Gets both, works immediately

No environment variables, no manual configuration, just works! ðŸš€
