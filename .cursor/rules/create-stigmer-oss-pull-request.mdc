---
description: Action rule to create a branch, commit, push, and open a GitHub PR using gh. Uses @generate-pr-info to generate PR title and Markdown body. Non-interactive, safe defaults.
globs:
alwaysApply: false
---

# Rule: Create Branch and Open PR (action)

Purpose: When invoked, generate a PR title and Markdown description via `@generate-pr-info`, then create a branch, commit local changes (if any), push, and open a GitHub Pull Request via the GitHub CLI (`gh`).

This is an action rule. Execute commands non-interactively and avoid prompts. If a prerequisite is missing (e.g., `gh` auth), stop with a clear message and instructions.

Usage: Invoke explicitly as `@create-pr`.

References: `@generate-pr-info`, `@README.md`.

## Preconditions
- `gh` installed and authenticated (`gh auth status` succeeds).
- Current repo has a writable `origin` remote.
- You have already staged or will stage changes to include in the commit, or skip commit if nothing changed.

## High-level flow
1. Generate PR info via `@generate-pr-info` and capture:
   - TITLE: the first fenced `text` block (single line)
   - BODY: the second fenced `markdown` block (multiline)
2. Derive a branch name from TITLE (heuristics below).
3. Create branch, commit changes, push to origin.
4. Create PR using `gh pr create`.

## Branch naming heuristic
- Extract `<type>` (prefix before `(`) and `<scope>` (inside parentheses) from the TITLE when present.
- Create a lowercase, hyphenated slug from the remainder of the TITLE.
- Branch name pattern: `<type>/<scope-or-area>-<short-slug>` (slashes in scope become `-`).
- Fallback: `chore/repo-<short-slug>` if parsing fails.

## Base branch detection
- Use `gh repo view --json defaultBranchRef -q .defaultBranchRef.name`
- Fallback: `main`

## Non-interactive workflow

```bash
set -euo pipefail

# 0) Preflight: ensure gh is installed and authenticated
if ! command -v gh >/dev/null 2>&1; then
  echo "Error: GitHub CLI (gh) is not installed. Install with: brew install gh" >&2
  exit 1
fi
if ! gh auth status >/dev/null 2>&1; then
  echo "Error: gh is not authenticated. Run: gh auth login" >&2
  exit 1
fi

# 1) Generate PR info via @generate-pr-info (must run this rule first and capture its two code blocks)
# EXPECT: variables TITLE and BODY populated from @pr-info output
: "${TITLE?Missing TITLE from @generate-pr-info}"
: "${BODY?Missing BODY from @generate-pr-info}"

# 2) Derive branch name from TITLE
_title_no_prefix="$(printf "%s" "$TITLE" | sed -E 's/^[a-z]+(\([^)]*\))?:\s*//')"
_type="$(printf "%s" "$TITLE" | sed -nE 's/^([a-z]+).*$/\1/p')"
_scope="$(printf "%s" "$TITLE" | sed -nE 's/^[a-z]+\(([^)]*)\).*/\1/p')"
_scope_slug="$(printf "%s" "${_scope:-repo}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9\-/' '-' | sed 's#/+#-#g')"
_slug="$(printf "%s" "${_title_no_prefix:-change}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-' | sed -E 's/-+/-/g;s/^-|-$//g' | cut -c1-40)"
_type_fallback="${_type:-chore}"
branch_name="${_type_fallback}/${_scope_slug}-${_slug}"

# 3) Create branch, commit, push
git checkout -b "$branch_name"
git add -A
git commit -m "$TITLE" || echo "No changes to commit"
git push -u origin "$branch_name"

# 4) Create PR
gh pr create --title "$TITLE" --body "$BODY"
```

## Options (optional, if provided in context)
- Draft PR: add `--draft` flag
- Reviewers: add `--reviewer user1,user2`
- Labels: add `--label label1,label2`
- Base branch override: add `--base main`

## Notes
- This rule depends on `@generate-pr-info` to produce high-quality TITLE and BODY.
- If the branch exists, switch to it instead of creating.
- If no changes, skip commit but still create PR if branch has commits.

@generate-pr-info
@README.md
